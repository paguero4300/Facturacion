# üìÑ Sistema de Facturaci√≥n Electr√≥nica - An√°lisis Completo

## üéØ Introducci√≥n

Este documento detalla la arquitectura completa del sistema de facturaci√≥n electr√≥nica desarrollado en Laravel con Filament, que integra servicios de QPSE y Greenter para el cumplimiento de normativas SUNAT en Per√∫.

### üîó Punto de Acceso Principal
**Ruta de creaci√≥n**: `/admin/invoices/create`

## üìã Tipos de Documentos Soportados

Seg√∫n la configuraci√≥n del sistema, se soportan los siguientes tipos de documentos electr√≥nicos:

| C√≥digo | Tipo de Documento | Descripci√≥n |
|--------|------------------|-------------|
| `01` | **Factura** | Comprobante de pago para empresas con RUC |
| `03` | **Boleta de Venta** | Comprobante de pago para personas naturales |
| `07` | **Nota de Cr√©dito** | Documento que reduce el valor de una factura |
| `08` | **Nota de D√©bito** | Documento que incrementa el valor de una factura |
| `09` | **Nota de Venta** | Documento interno (no electr√≥nico) |

## üèóÔ∏è Arquitectura del Sistema

### Estructura de Directorios Clave
```
app/
‚îú‚îÄ‚îÄ Models/                    # Modelos de datos
‚îú‚îÄ‚îÄ Http/Controllers/          # Controladores HTTP
‚îú‚îÄ‚îÄ Filament/Resources/        # Recursos de Filament Admin
‚îú‚îÄ‚îÄ Services/                  # Servicios de l√≥gica de negocio
‚îú‚îÄ‚îÄ Observers/                 # Observadores de eventos
‚îú‚îÄ‚îÄ Enums/                     # Enumeraciones
‚îî‚îÄ‚îÄ Mail/                      # Clases de email

config/
‚îú‚îÄ‚îÄ greenter.php              # Configuraci√≥n Greenter
‚îú‚îÄ‚îÄ qpse.php                  # Configuraci√≥n QPSE
‚îî‚îÄ‚îÄ invoice-pdf.php           # Configuraci√≥n PDF

qpse_ejemplos/                # Ejemplos de documentos QPSE
```

## üóÑÔ∏è Modelos de Datos Principales

### 1. **Invoice** (Modelo Principal)
**Ubicaci√≥n**: `app/Models/Invoice.php`

**Atributos Principales**:
- `company_id` - Empresa emisora
- `client_id` - Cliente receptor
- `document_series_id` - Serie del documento
- `document_type` - Tipo de documento (01, 03, 07, 08, 09)
- `series` - Serie del comprobante
- `number` - N√∫mero correlativo
- `full_number` - N√∫mero completo (serie-n√∫mero)
- `issue_date` - Fecha de emisi√≥n
- `currency_code` - Moneda (PEN/USD)
- `exchange_rate` - Tipo de cambio
- `subtotal` - Subtotal sin impuestos
- `igv_amount` - Monto del IGV
- `total_amount` - Total del documento
- `payment_condition` - Condici√≥n de pago (immediate/credit)
- `sunat_status` - Estado en SUNAT
- `status` - Estado interno

**Relaciones**:
- `company()` - BelongsTo Company
- `client()` - BelongsTo Client
- `documentSeries()` - BelongsTo DocumentSeries
- `details()` - HasMany InvoiceDetail
- `paymentInstallments()` - HasMany PaymentInstallment

### 2. **InvoiceDetail** (Detalle de Productos)
**Ubicaci√≥n**: `app/Models/InvoiceDetail.php`

**Atributos Principales**:
- `invoice_id` - ID de la factura
- `product_id` - ID del producto
- `line_number` - N√∫mero de l√≠nea
- `description` - Descripci√≥n del producto
- `quantity` - Cantidad
- `unit_price` - Precio unitario
- `net_amount` - Monto neto
- `igv_amount` - IGV de la l√≠nea
- `line_total` - Total de la l√≠nea
- `tax_type` - Tipo de afectaci√≥n IGV

### 3. **Company** (Empresa Emisora)
**Ubicaci√≥n**: `app/Models/Company.php`

**Atributos para Facturaci√≥n**:
- `ruc` - RUC de la empresa
- `business_name` - Raz√≥n social
- `commercial_name` - Nombre comercial
- `address` - Direcci√≥n
- `ose_provider` - Proveedor OSE (qpse)
- `ose_username` - Usuario OSE
- `ose_password` - Contrase√±a OSE

### 4. **Client** (Cliente)
**Ubicaci√≥n**: `app/Models/Client.php`

**Atributos Principales**:
- `document_type` - Tipo de documento (1=DNI, 6=RUC)
- `document_number` - N√∫mero de documento
- `business_name` - Raz√≥n social/nombre
- `address` - Direcci√≥n
- `email` - Email

### 5. **DocumentSeries** (Series de Documentos)
**Ubicaci√≥n**: `app/Models/DocumentSeries.php`

**Funcionalidad**:
- Controla la numeraci√≥n autom√°tica
- Asigna series por tipo de documento
- M√©todo `getNextNumber()` para correlativo

## üîó Rutas y Controladores

### Rutas Principales
**Archivo**: `routes/web.php`

```php
// Rutas de Filament (autom√°ticas)
/admin/invoices/create     // P√°gina de creaci√≥n
/admin/invoices/edit/{id}  // P√°gina de edici√≥n
/admin/invoices/view/{id}  // P√°gina de visualizaci√≥n

// Rutas de PDF
Route::prefix('invoices')->name('invoices.')->group(function () {
    Route::get('{invoice}/pdf/download', [InvoicePdfController::class, 'download']);
    Route::get('{invoice}/pdf/view', [InvoicePdfController::class, 'view']);
    Route::get('{invoice}/ticket/download', [InvoicePdfController::class, 'ticket']);
});
```

### Controladores Principales

#### 1. **InvoicePdfController**
**Ubicaci√≥n**: `app/Http/Controllers/InvoicePdfController.php`

**M√©todos**:
- `download()` - Descarga PDF A4
- `view()` - Vista previa PDF
- `ticket()` - Impresi√≥n ticket 80mm
- `store()` - Guardar PDF en storage

#### 2. **CheckoutController**
**Ubicaci√≥n**: `app/Http/Controllers/CheckoutController.php`

**Responsabilidad**:
- Manejo de pedidos web
- Creaci√≥n de Notas de Venta (09)
- Validaci√≥n de pagos

## üéõÔ∏è Filament Resources

### InvoiceResource
**Ubicaci√≥n**: `app/Filament/Resources/InvoiceResource.php`

#### Formulario de Creaci√≥n
**Secciones del Formulario**:

1. **Datos B√°sicos**:
   - Selecci√≥n de empresa
   - Selecci√≥n de cliente (con validaci√≥n por tipo de documento)
   - Tipo de documento
   - Serie autom√°tica
   - Fecha de emisi√≥n
   - Moneda y tipo de cambio
   - Condici√≥n de pago

2. **Detalle de Productos**:
   - Repeater con l√≠neas de productos
   - C√°lculo autom√°tico de totales
   - Soporte para IGV y exonerados

3. **Resumen**:
   - Totales calculados din√°micamente
   - Conversi√≥n a letras

#### P√°ginas del Resource

##### CreateInvoice
**Ubicaci√≥n**: `app/Filament/Resources/InvoiceResource/Pages/CreateInvoice.php`

**Funcionalidades**:
- Asignaci√≥n autom√°tica de empresa activa
- Snapshot de datos del cliente
- Asignaci√≥n at√≥mica de serie y correlativo
- Manejo de transacciones

**M√©todo Clave**:
```php
protected function mutateFormDataBeforeCreate(array $data): array
{
    // Asignaci√≥n de empresa activa
    // Snapshot de datos del cliente
    // Asignaci√≥n de serie y n√∫mero
    // Control de concurrencia
}
```

## ‚öôÔ∏è Servicios de L√≥gica de Negocio

### 1. **ElectronicInvoiceService**
**Ubicaci√≥n**: `app/Services/ElectronicInvoiceService.php`

**Responsabilidades**:
- Coordinaci√≥n del env√≠o a SUNAT
- Transformaci√≥n de datos del modelo a formato QPSE
- Manejo de respuestas y errores
- Actualizaci√≥n de estados

**M√©todos Principales**:
- `sendFactura()` - Env√≠o de facturas
- `sendBoleta()` - Env√≠o de boletas
- `sendNotaCredito()` - Env√≠o de notas de cr√©dito
- `sendNotaDebito()` - Env√≠o de notas de d√©bito
- `resendDocument()` - Reenv√≠o de documentos

### 2. **QpseService**
**Ubicaci√≥n**: `app/Services/QpseService.php`

**Responsabilidades**:
- Comunicaci√≥n directa con API de QPSE
- Manejo de autenticaci√≥n
- Firmado de XML
- Env√≠o a SUNAT v√≠a QPSE

**M√©todos Principales**:
- `obtenerToken()` - Autenticaci√≥n con QPSE
- `firmarXml()` - Firmado digital
- `enviarXmlFirmado()` - Env√≠o a SUNAT
- `procesarDocumento()` - Proceso completo

### 3. **QpseGreenterAdapter**
**Ubicaci√≥n**: `app/Services/QpseGreenterAdapter.php`

**Responsabilidad**:
- Adaptador entre Greenter y QPSE
- Transformaci√≥n de formatos
- Abstracci√≥n de la integraci√≥n

### 4. **GreenterXmlService**
**Ubicaci√≥n**: `app/Services/GreenterXmlService.php`

**Responsabilidad**:
- Generaci√≥n de XML usando Greenter
- Construcci√≥n de objetos Greenter
- Conversi√≥n de datos del sistema

### 5. **FactilizaService**
**Ubicaci√≥n**: `app/Services/FactilizaService.php`

**Responsabilidad**:
- Integraci√≥n con API de Factiliza
- Consulta de datos de RUC/DNI
- Obtenci√≥n de tipos de cambio

## üîß Archivos de Configuraci√≥n

### 1. **config/greenter.php**
```php
return [
    'mode' => env('GREENTER_MODE', 'beta'),
    'company' => [
        'ruc' => env('GREENTER_COMPANY_RUC'),
        'razonSocial' => env('GREENTER_COMPANY_NAME'),
        // Configuraci√≥n de empresa
    ],
    'endpoints' => [
        // URLs de SUNAT para beta y producci√≥n
    ],
];
```

### 2. **config/qpse.php**
```php
return [
    'mode' => env('QPSE_MODE', 'demo'),
    'url' => env('QPSE_URL', 'https://demo-cpe.qpse.pe'),
    'token' => env('QPSE_TOKEN'),
    'integration' => [
        'use_pse' => env('QPSE_USE_PSE', true),
        'timeout' => env('QPSE_TIMEOUT', 30),
    ],
    'document_types' => [
        'invoice' => '01',
        'credit' => '07',
        'debit' => '08',
    ],
];
```

### 3. **config/invoice-pdf.php**
```php
return [
    'format' => 'A4',
    'margins' => [
        'top' => 10, 'right' => 10,
        'bottom' => 10, 'left' => 10,
    ],
    'company' => [
        'logo_path' => 'images/logo.png',
        'show_logo' => true,
    ],
    'document' => [
        'show_qr_code' => true,
        'show_footer' => true,
    ],
];
```

## üëÅÔ∏è Observers (Automatizaci√≥n)

### 1. **InvoiceObserver**
**Ubicaci√≥n**: `app/Observers/InvoiceObserver.php`

**Eventos Manejados**:
- `saved()` - Rec√°lculo de totales
- `updated()` - Actualizaci√≥n de totales

**Funcionalidades**:
```php
protected function calculateTotals(Invoice $invoice)
{
    // C√°lculo de subtotal, IGV y total
    // Generaci√≥n autom√°tica de cuotas para cr√©dito
    // Prevenci√≥n de recursi√≥n
}

protected function generateInstallments(Invoice $invoice)
{
    // Generaci√≥n autom√°tica de cuotas
    // Distribuci√≥n proporcional de montos
    // C√°lculo de fechas de vencimiento
}
```

### 2. **InvoiceDetailObserver**
**Ubicaci√≥n**: `app/Observers/InvoiceDetailObserver.php`

**Responsabilidad**:
- Rec√°lculo cuando se modifican detalles
- Actualizaci√≥n de inventario
- Validaciones de stock

## üîÑ Flujo Completo de Creaci√≥n

### 1. **Acceso Inicial**
```
Usuario accede a: /admin/invoices/create
‚Üì
Se carga: InvoiceResource::form()
‚Üì
Se presenta: Formulario con 3 secciones
```

### 2. **Selecci√≥n de Datos B√°sicos**
```
Usuario selecciona:
- Empresa (autom√°tica si solo hay una activa)
- Tipo de documento (01, 03, 07, 08, 09)
- Serie (se filtra por empresa y tipo)
- Cliente (se valida seg√∫n tipo de documento)
```

### 3. **Configuraci√≥n de Documento**
```
Sistema configura autom√°ticamente:
- N√∫mero correlativo (siguiente disponible)
- Fecha de emisi√≥n (hoy)
- Moneda y tipo de cambio
- Condici√≥n de pago
```

### 4. **Captura de Detalle**
```
Usuario agrega productos:
- Selecci√≥n de producto
- Cantidad y precio
- C√°lculo autom√°tico de IGV
- Totales din√°micos
```

### 5. **Procesamiento Backend**
```
Al enviar formulario:
‚Üì
CreateInvoice::mutateFormDataBeforeCreate()
‚îú‚îÄ‚îÄ Asigna empresa activa
‚îú‚îÄ‚îÄ Captura datos del cliente (snapshot)
‚îú‚îÄ‚îÄ Asigna serie y correlativo (transacci√≥n)
‚îî‚îÄ‚îÄ Valida datos
‚Üì
Se crea Invoice en base de datos
‚Üì
InvoiceObserver::saved()
‚îú‚îÄ‚îÄ Calcula totales autom√°ticamente
‚îú‚îÄ‚îÄ Genera cuotas si es cr√©dito
‚îî‚îÄ‚îÄ Actualiza campos calculados
```

### 6. **Post-Creaci√≥n**
```
Documento creado exitosamente:
‚îú‚îÄ‚îÄ Estado inicial: 'issued'
‚îú‚îÄ‚îÄ SUNAT status: 'pending'
‚îú‚îÄ‚îÄ Totales calculados
‚îú‚îÄ‚îÄ Cuotas generadas (si aplica)
‚îî‚îÄ‚îÄ Listo para env√≠o a SUNAT
```

## üöÄ Integraci√≥n SUNAT/QPSE

### Proceso de Env√≠o Electr√≥nico

#### 1. **Preparaci√≥n de Datos**
```php
ElectronicInvoiceService::buildDocumentData()
‚îú‚îÄ‚îÄ Convierte Invoice model a formato QPSE
‚îú‚îÄ‚îÄ Estructura datos de empresa
‚îú‚îÄ‚îÄ Estructura datos de cliente
‚îú‚îÄ‚îÄ Procesa detalles de productos
‚îî‚îÄ‚îÄ Calcula totales y leyendas
```

#### 2. **Generaci√≥n XML**
```php
GreenterXmlService::generateInvoiceXml()
‚îú‚îÄ‚îÄ Construye objetos Greenter
‚îú‚îÄ‚îÄ Aplica configuraciones
‚îú‚îÄ‚îÄ Genera XML estructurado
‚îî‚îÄ‚îÄ Retorna XML sin firmar
```

#### 3. **Firmado Digital**
```php
QpseService::firmarXml()
‚îú‚îÄ‚îÄ Autenticaci√≥n con QPSE
‚îú‚îÄ‚îÄ Env√≠o de XML para firmado
‚îú‚îÄ‚îÄ Recepci√≥n de XML firmado
‚îî‚îÄ‚îÄ Preparaci√≥n para env√≠o
```

#### 4. **Env√≠o a SUNAT**
```php
QpseService::enviarXmlFirmado()
‚îú‚îÄ‚îÄ Env√≠o v√≠a QPSE a SUNAT
‚îú‚îÄ‚îÄ Recepci√≥n de CDR
‚îú‚îÄ‚îÄ Procesamiento de respuesta
‚îî‚îÄ‚îÄ Actualizaci√≥n de estado
```

#### 5. **Manejo de Respuesta**
```php
ElectronicInvoiceService::processResult()
‚îú‚îÄ‚îÄ An√°lisis de respuesta SUNAT
‚îú‚îÄ‚îÄ Actualizaci√≥n de Invoice
‚îú‚îÄ‚îÄ Guardado de CDR
‚îî‚îÄ‚îÄ Notificaciones de estado
```

## üìä Estados de Documentos

### Estados Internos (status)
- `draft` - Borrador
- `issued` - Emitido
- `paid` - Pagado
- `partial_paid` - Pago parcial
- `cancelled` - Anulado

### Estados SUNAT (sunat_status)
- `pending` - Pendiente de env√≠o
- `sent` - Enviado a SUNAT
- `accepted` - Aceptado por SUNAT
- `rejected` - Rechazado por SUNAT
- `observed` - Observado por SUNAT

## üîç Caracter√≠sticas Avanzadas

### 1. **Validaci√≥n de Documentos**
- Validaci√≥n de RUC/DNI v√≠a Factiliza
- Verificaci√≥n de tipos de documento por cliente
- Control de series y correlativos √∫nicos

### 2. **Manejo de Monedas**
- Soporte para PEN y USD
- Tipo de cambio autom√°tico
- C√°lculos multi-moneda

### 3. **Condiciones de Pago**
- Pago inmediato (contado)
- Pago a cr√©dito con cuotas
- Generaci√≥n autom√°tica de cronograma

### 4. **Generaci√≥n de PDFs**
- PDF A4 para impresi√≥n formal
- Tickets 80mm para POS
- Configuraci√≥n personalizable
- M√∫ltiples formatos de descarga

### 5. **Sistema de Entrega**
- Programaci√≥n de entregas
- Estados de entrega
- Notificaciones autom√°ticas
- Validaci√≥n de pagos

## üöß Conclusiones

Este sistema de facturaci√≥n electr√≥nica est√° construido con una arquitectura robusta que:

1. **Cumple normativas SUNAT** mediante integraci√≥n QPSE
2. **Automatiza procesos** con Observers y eventos
3. **Facilita la operaci√≥n** con interfaz Filament intuitiva
4. **Maneja m√∫ltiples escenarios** de negocio
5. **Escala eficientemente** con servicios modulares
6. **Mantiene integridad** con validaciones y transacciones

La arquitectura modular permite extensibilidad y mantenimiento, mientras que la integraci√≥n con QPSE asegura el cumplimiento de las regulaciones peruanas de facturaci√≥n electr√≥nica.